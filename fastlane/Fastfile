default_platform(:ios)

# Common í—¬í¼ íŒŒì¼ë“¤ import
import "common/auth_helper.rb"
import "common/app_helper.rb"
import "common/version_helper.rb"

platform :ios do
  desc "Upload to TestFlight"
  lane :upload_testflight do
    # xcodebuild íƒ€ì„ì•„ì›ƒ ì„¤ì • (ì´ˆ ë‹¨ìœ„)
    ENV['FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT'] = '120'  # 2ë¶„ìœ¼ë¡œ ëŠ˜ë¦¼
    ENV['FASTLANE_XCODEBUILD_SETTINGS_RETRIES'] = '2'   # ì¬ì‹œë„ íšŸìˆ˜ ì¤„ì„
    
    xcode_select "/Applications/Xcode-16.3.0.app" # Xcode ë²„ì „ ì§€ì •
    setup_api_key
    
    app_name = select_app
    if app_name.nil?
      UI.error("ì•± ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
      next
    end
    
    app_info = get_app_info(app_name)
    if app_info.nil?
      next
    end
    
    version_number = UI.input("ìƒˆ ë²„ì „ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (í˜„ì¬ê°’ ìœ ì§€í•˜ë ¤ë©´ ì—”í„°): ")
    
    # ë¹Œë“œ ë²ˆí˜¸ë¥¼ í˜„ì¬ ë‚ ì§œì‹œê°„ìœ¼ë¡œ ìë™ ìƒì„± (ì˜ˆ: 20241201140530)
    build_number = Time.now.strftime("%Y%m%d%H%M%S")
    UI.message("ìë™ ìƒì„±ëœ ë¹Œë“œ ë²ˆí˜¸: #{build_number}")
    
    update_version(
      app_info, 
      version_number.empty? ? nil : version_number,
      build_number
    )
    
        UI.message("#{app_info[:name]} ì•±ì„ TestFlightì— ì—…ë¡œë“œí•©ë‹ˆë‹¤...")
    
    # App Store ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ë§¤ì¹˜
    ENV['MATCH_TYPE'] = 'appstore'
    match(
      type: "appstore",
      app_identifier: app_info[:bundle_id],
      readonly: true,
      force_legacy_encryption: true,
      username: "mooyoung2309@gmail.com"
    )
    
    enable_automatic_code_signing(
      path: app_info[:project_path]
    )
    
    # Swift Package Manager ì˜ì¡´ì„± ë¯¸ë¦¬ í•´ê²°
    UI.message("Swift Package ì˜ì¡´ì„±ì„ ë¯¸ë¦¬ í•´ê²°í•©ë‹ˆë‹¤...")
    sh("cd .. && xcodebuild -resolvePackageDependencies -scheme #{app_info[:scheme]} -project #{app_info[:project_path]} || true")
    
    # í”„ë¡œì íŠ¸ ë¹Œë“œ ì„¤ì • í™•ì¸ (ë””ë²„ê¹…ìš©)
    UI.message("ë¹Œë“œ ì„¤ì •ì„ í™•ì¸í•©ë‹ˆë‹¤...")
    sh("cd .. && timeout 60 xcodebuild -showBuildSettings -scheme #{app_info[:scheme]} -project #{app_info[:project_path]} -configuration Release | head -20 || echo 'ë¹Œë“œ ì„¤ì • í™•ì¸ íƒ€ì„ì•„ì›ƒ'")
    
    gym(
      scheme: app_info[:scheme],
      project: app_info[:project_path],
      configuration: "Release",
      export_method: "app-store",
      clean: true,
      skip_build_archive: false,
      skip_package_dependencies_resolution: false,
      destination: "generic/platform=iOS"
    )
    
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      notify_external_testers: false
    )
    
    UI.success("#{app_info[:name]} ì•±ì´ ì„±ê³µì ìœ¼ë¡œ TestFlightì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰")
  end
  
  desc "Delete all certificates and profiles (development + appstore)"
  lane :nuke do
    setup_api_key
    
    UI.message("ëª¨ë“  ì¸ì¦ì„œì™€ í”„ë¡œíŒŒì¼ì„ ì‚­ì œí•©ë‹ˆë‹¤...")
    
    # Development ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ì‚­ì œ
    UI.message("Development ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ì‚­ì œ ì¤‘...")
    ENV['MATCH_TYPE'] = 'development'
    match_nuke(
      type: "development",
      app_identifier: get_all_bundle_ids,
      skip_confirmation: false
    )
    
    # App Store ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ì‚­ì œ
    UI.message("App Store ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ì‚­ì œ ì¤‘...")
    ENV['MATCH_TYPE'] = 'appstore'
    match_nuke(
      type: "appstore",
      app_identifier: get_all_bundle_ids,
      skip_confirmation: false
    )
    
    UI.success("ëª¨ë“  ì¸ì¦ì„œì™€ í”„ë¡œíŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ—‘ï¸")
  end
  
  desc "Generate certificates and profiles (development + appstore)"
  lane :sign do
    setup_api_key
    
    UI.message("ì¸ì¦ì„œì™€ í”„ë¡œíŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤...")
    
    # Development ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ìƒì„±
    UI.message("Development ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ìƒì„± ì¤‘...")
    ENV['MATCH_TYPE'] = 'development'
    match(
      type: "development",
      app_identifier: get_all_bundle_ids,
      readonly: false,
      force_legacy_encryption: true,
      username: "mooyoung2309@gmail.com"
    )
    
    # App Store ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ìƒì„±
    UI.message("App Store ì¸ì¦ì„œ/í”„ë¡œíŒŒì¼ ìƒì„± ì¤‘...")
    ENV['MATCH_TYPE'] = 'appstore'
    match(
      type: "appstore",
      app_identifier: get_all_bundle_ids,
      readonly: false,
      force_legacy_encryption: true,
      username: "mooyoung2309@gmail.com"
    )
    
    UI.success("ëª¨ë“  ì¸ì¦ì„œì™€ í”„ë¡œíŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”")
  end
  
  desc "Clean build cache and dependencies"
  lane :clean_all do
    UI.message("ë¹Œë“œ ìºì‹œì™€ ì˜ì¡´ì„±ì„ ì •ë¦¬í•©ë‹ˆë‹¤...")
    
    # DerivedData ì •ë¦¬
    clear_derived_data
    
    # Swift Package ìºì‹œ ì •ë¦¬
    sh("cd .. && rm -rf ~/Library/Caches/org.swift.swiftpm || true")
    sh("cd .. && rm -rf ~/Library/Developer/Xcode/DerivedData || true")
    
    # ê° ì•±ì˜ íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ë‹¤ì‹œ í•´ê²°
    ["Plots", "FewCuts", "FewRetros", "Toff"].each do |app_name|
      project_path = "Apps/#{app_name}/#{app_name}.xcodeproj"
      if File.exist?(File.expand_path("../#{project_path}", __dir__))
        UI.message("#{app_name} ì˜ì¡´ì„± í•´ê²° ì¤‘...")
        sh("cd .. && xcodebuild -resolvePackageDependencies -scheme #{app_name} -project #{project_path} || true")
      end
    end
    
    UI.success("ì •ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ§¹")
  end
end