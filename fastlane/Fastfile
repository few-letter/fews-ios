default_platform(:ios)

# ì•± ì„¤ì • (í™˜ê²½ë³€ìˆ˜ ëŒ€ì‹  í•˜ë“œì½”ë”©ìœ¼ë¡œ ê°„ì†Œí™”)
APPS = {
  "Plots" => "com.annapo.plotfolio",
  "FewCuts" => "com.annapo.fewcuts", 
  "FewRetros" => "com.annapo.kpt",
  "Toff" => "com.tamsadan.toolinder"
}

platform :ios do
  before_all do
    # API í‚¤ ì„¤ì • (ê°„ì†Œí™”)
    api_key_json = JSON.parse(File.read("api_key.json"))
    app_store_connect_api_key(
      key_id: api_key_json["key_id"],
      issuer_id: api_key_json["issuer_id"], 
      key_content: api_key_json["key"]
    )
  end

  desc "Upload to TestFlight"
  lane :upload do
    # ì•± ì„ íƒ (ìˆ«ìë¡œ ì„ íƒ)
    app_names = APPS.keys
    UI.message("ì•±ì„ ì„ íƒí•˜ì„¸ìš”:")
    app_names.each_with_index { |name, i| UI.message("#{i+1}. #{name}") }
    
    choice = UI.input("ë²ˆí˜¸ ì„ íƒ (1-#{app_names.length}): ").to_i
    unless (1..app_names.length).include?(choice)
      UI.error("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤")
      next
    end
    
    app_name = app_names[choice-1]
    bundle_id = APPS[app_name]
    UI.success("ì„ íƒëœ ì•±: #{app_name}")

    # í˜„ì¬ ë²„ì „ ì •ë³´ í‘œì‹œ í›„ ìƒˆ ë²„ì „ ì…ë ¥
    plist_path = "Apps/#{app_name}/Resources/Info.plist"
    current_version = get_info_plist_value(path: plist_path, key: "CFBundleShortVersionString")
    UI.message("í˜„ì¬ ë²„ì „: #{current_version}")
    
    version = UI.input("ìƒˆ ë²„ì „ (í˜„ì¬ê°’ ìœ ì§€í•˜ë ¤ë©´ ì—”í„°): ")
    build = Time.now.strftime("%Y%m%d%H%M%S")
    UI.message("ë¹Œë“œ ë²ˆí˜¸: #{build}")
    
    project_path = "Apps/#{app_name}/#{app_name}.xcodeproj"
    
    # ë²„ì „ ì—…ë°ì´íŠ¸
    set_info_plist_value(path: plist_path, key: "CFBundleShortVersionString", value: version) unless version.empty?
    set_info_plist_value(path: plist_path, key: "CFBundleVersion", value: build)
    
    # ì½”ë“œ ì‚¬ì´ë‹
    match(type: "appstore", app_identifier: bundle_id, readonly: true, username: "mooyoung2309@gmail.com")
    enable_automatic_code_signing(path: project_path)
    
    # ë¹Œë“œ & ì—…ë¡œë“œ
    gym(
      scheme: app_name,
      project: project_path, 
      configuration: "Release",
      export_method: "app-store"
    )
    
    upload_to_testflight(skip_waiting_for_build_processing: true)
    UI.success("#{app_name} uploaded! ğŸ‰")
  end
  
  desc "Reset certificates"
  lane :reset do
    ["development", "appstore"].each do |type|
      match_nuke(type: type, app_identifier: APPS.values)
      match(type: type, app_identifier: APPS.values, readonly: false, username: "mooyoung2309@gmail.com")
    end
    UI.success("Certificates reset! ğŸ”")
  end
  
  desc "Clean everything"
  lane :clean do
    clear_derived_data
    sh("rm -rf ~/Library/Caches/org.swift.swiftpm", error_callback: ->(result) {})
    UI.success("Cleaned! ğŸ§¹")
  end
end