default_platform(:ios)

# ì•± ì„ íƒ í•¨ìˆ˜
def select_app
  # Apps ë””ë ‰í† ë¦¬ì—ì„œ ì•± ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  apps_dir = File.expand_path("../Apps", __dir__)
  apps = Dir.entries(apps_dir)
             .select { |entry| File.directory?(File.join(apps_dir, entry)) }
             .reject { |entry| entry.start_with?('.') || entry == 'Derived' || entry == 'Tuist' || entry == 'Apps' || entry.include?('.xc') }
             .select { |entry| File.exist?(File.join(apps_dir, entry, "#{entry}.xcodeproj")) }
             .sort
  
  if apps.empty?
    UI.error("Apps ë””ë ‰í† ë¦¬ì—ì„œ ì•±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    return nil
  end
  
  # ì‚¬ìš©ìì—ê²Œ ì•± ì„ íƒ ìš”ì²­
  UI.message("ì‚¬ìš© ê°€ëŠ¥í•œ ì•±ë“¤:")
  apps.each_with_index do |app, index|
    UI.message("#{index + 1}. #{app}")
  end
  
  choice = UI.input("ë¹Œë“œí•  ì•±ì„ ì„ íƒí•˜ì„¸ìš” (1-#{apps.length}): ")
  
  begin
    index = choice.to_i - 1
    if index >= 0 && index < apps.length
      selected_app = apps[index]
      UI.success("ì„ íƒëœ ì•±: #{selected_app}")
      return selected_app
    else
      UI.error("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.")
      return nil
    end
  rescue
    UI.error("ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤.")
    return nil
  end
end

# ì•± ì •ë³´ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
def get_app_info(app_name)
  project_path = "Apps/#{app_name}/#{app_name}.xcodeproj"
  full_project_path = File.expand_path("../Apps/#{app_name}/#{app_name}.xcodeproj", __dir__)
  
  # í”„ë¡œì íŠ¸ íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
  unless File.exist?(full_project_path)
    UI.error("í”„ë¡œì íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: #{project_path}")
    return nil
  end
  
  return {
    name: app_name,
    project_path: project_path,
    scheme: app_name
  }
end

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    # ì•± ì„ íƒ
    app_name = select_app
    if app_name.nil?
      UI.error("ì•± ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
      next
    end
    
    app_info = get_app_info(app_name)
    if app_info.nil?
      next
    end
    
    UI.message("#{app_info[:name]} ì•±ì„ TestFlightì— ì—…ë¡œë“œí•©ë‹ˆë‹¤...")
    
    # ì•± ë¹Œë“œ
    gym(
      scheme: app_info[:scheme],
      configuration: "Release",
      export_method: "app-store",
      project: app_info[:project_path],
      export_options: {
        signingStyle: "automatic"
      }
    )
    
    # TestFlightì— ì—…ë¡œë“œ
    pilot(
      skip_waiting_for_build_processing: true
    )
    
    UI.success("#{app_info[:name]} ì•±ì´ ì„±ê³µì ìœ¼ë¡œ TestFlightì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰")
  end
  
  desc "Simple build test"
  lane :build_test do
    # ì•± ì„ íƒ
    app_name = select_app
    if app_name.nil?
      UI.error("ì•± ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
      next
    end
    
    app_info = get_app_info(app_name)
    if app_info.nil?
      next
    end
    
    UI.message("#{app_info[:name]} ì•±ì„ ë¹Œë“œ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤...")
    
    gym(
      scheme: app_info[:scheme],
      configuration: "Debug",
      project: app_info[:project_path],
      skip_archive: true,
      skip_codesigning: true
    )
    
    UI.success("#{app_info[:name]} ì•± ë¹Œë“œ í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! âœ…")
  end
  
  desc "Release build (without upload)"
  lane :build_release do
    # ì•± ì„ íƒ
    app_name = select_app
    if app_name.nil?
      UI.error("ì•± ì„ íƒì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.")
      next
    end
    
    app_info = get_app_info(app_name)
    if app_info.nil?
      next
    end
    
    UI.message("#{app_info[:name]} ì•±ì„ Release ë¹Œë“œí•©ë‹ˆë‹¤...")
    
    gym(
      scheme: app_info[:scheme],
      configuration: "Release",
      export_method: "app-store",
      project: app_info[:project_path],
      export_options: {
        signingStyle: "automatic"
      }
    )
    
    UI.success("#{app_info[:name]} ì•± Release ë¹Œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¦")
  end
  
  desc "Show available apps"
  lane :list_apps do
    apps_dir = File.expand_path("../Apps", __dir__)
    apps = Dir.entries(apps_dir)
               .select { |entry| File.directory?(File.join(apps_dir, entry)) }
               .reject { |entry| entry.start_with?('.') || entry == 'Derived' || entry == 'Tuist' || entry == 'Apps' || entry.include?('.xc') }
               .select { |entry| File.exist?(File.join(apps_dir, entry, "#{entry}.xcodeproj")) }
               .sort
    
    UI.message("ì‚¬ìš© ê°€ëŠ¥í•œ ì•±ë“¤:")
    apps.each_with_index do |app, index|
      project_path = File.expand_path("../Apps/#{app}/#{app}.xcodeproj", __dir__)
      status = File.exist?(project_path) ? "âœ…" : "âŒ"
      UI.message("#{index + 1}. #{app} #{status}")
    end
  end
end 