default_platform(:ios)

# ì•± ì„¤ì • (í™˜ê²½ë³€ìˆ˜ ëŒ€ì‹  í•˜ë“œì½”ë”©ìœ¼ë¡œ ê°„ì†Œí™”)
APPS = {
  "Toffs" => "com.tamsadan.toolinder",
  "Plots" => "com.annapo.plotfolio",
  "Retros" => "com.annapo.kpt",
  "Multis" => "com.annapo.taskfolio",
  "FewCuts" => "com.annapo.fewcuts"
}

# Tuist ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²½ë¡œ
WORKSPACE_NAME = "FewsWorkspace"

platform :ios do
  before_all do
    # API í‚¤ ì„¤ì • (ê°„ì†Œí™”)
    api_key_json = JSON.parse(File.read("api_key.json"))
    app_store_connect_api_key(
      key_id: api_key_json["key_id"],
      issuer_id: api_key_json["issuer_id"], 
      key_content: api_key_json["key"]
    )
    
    # xcodebuild íƒ€ì„ì•„ì›ƒ ì„¤ì • (ë³µì¡í•œ íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ë•Œë¬¸ì— ì¦ê°€)
    ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "120"
    ENV["FASTLANE_XCODEBUILD_SETTINGS_RETRIES"] = "2"
  end

  # Tuist í”„ë¡œì íŠ¸ ìƒì„± í—¬í¼ ë©”ì„œë“œ
  private_lane :generate do
    UI.message("ğŸ”§ Tuist í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤...")
    
    Dir.chdir("..") do
      sh("tuist install", error_callback: ->(result) {
        UI.message("Tuist install ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ìˆì—ˆì§€ë§Œ ê³„ì† ì§„í–‰í•©ë‹ˆë‹¤.")
      })
      sh("tuist generate --no-open")
    end
    
    UI.success("âœ… Tuist í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ!")
  end

  desc "Upload to TestFlight"
  lane :upload do
    # ì•± ì„ íƒ (ìˆ«ìë¡œ ì„ íƒ)
    app_names = APPS.keys
    UI.message("ì•±ì„ ì„ íƒí•˜ì„¸ìš”:")
    app_names.each_with_index { |name, i| UI.message("#{i+1}. #{name}") }
    
    choice = UI.input("ë²ˆí˜¸ ì„ íƒ (1-#{app_names.length}): ").to_i
    unless (1..app_names.length).include?(choice)
      UI.error("ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤")
      next
    end
    
    app_name = app_names[choice-1]
    bundle_id = APPS[app_name]
    UI.success("ì„ íƒëœ ì•±: #{app_name}")

    # í˜„ì¬ ë²„ì „ ì •ë³´ í‘œì‹œ
    plist_path = "Apps/#{app_name}/Resources/Info.plist"
    
    # ê²½ë¡œ ë””ë²„ê¹…
    UI.message("ğŸ“ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬: #{Dir.pwd}")
    UI.message("ğŸ“„ Info.plist ê²½ë¡œ: #{plist_path}")
    
    if !File.exist?(plist_path)
      # ëŒ€ì•ˆ ê²½ë¡œë“¤ ì‹œë„
      alternative_paths = [
        "../Apps/#{app_name}/Resources/Info.plist",
        "#{app_name}/Resources/Info.plist",
        "../#{app_name}/Resources/Info.plist"
      ]
      
      alternative_paths.each do |alt_path|
        if File.exist?(alt_path)
          plist_path = File.expand_path(alt_path)  # ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
          UI.message("âœ… ëŒ€ì•ˆ ê²½ë¡œì—ì„œ íŒŒì¼ ë°œê²¬: #{plist_path}")
          break
        end
      end
    end
    
    unless File.exist?(plist_path)
      UI.error("Info.plist íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
      next
    end
    
    current_version = get_info_plist_value(path: plist_path, key: "CFBundleShortVersionString")
    UI.message("í˜„ì¬ ë²„ì „: #{current_version}")
    
    version = UI.input("ìƒˆ ë²„ì „ (í˜„ì¬ê°’ ìœ ì§€í•˜ë ¤ë©´ ì—”í„°): ")
    
    # ë¹Œë“œ ë²ˆí˜¸: ë…„ì›”ì¼ì‹œë¶„ì´ˆ
    build = Time.now.strftime("%Y%m%d%H%M%S")
    UI.message("ìƒˆ ë¹Œë“œ ë²ˆí˜¸: #{build}")
    
    # ë²„ì „ ì—…ë°ì´íŠ¸ (generate ì „ì—!)
    set_info_plist_value(path: plist_path, key: "CFBundleShortVersionString", value: version) unless version.empty?
    set_info_plist_value(path: plist_path, key: "CFBundleVersion", value: build)
    
    # ì •ë¦¬ ë° í”„ë¡œì íŠ¸ ìƒì„± (ë²„ì „ ì—…ë°ì´íŠ¸ í›„ì—!)
    clear_derived_data
    generate
    
    # ì½”ë“œ ì‚¬ì´ë‹ (Tuistê°€ ê¸°ë³¸ ì„œëª…ì„ ì²˜ë¦¬í•˜ì§€ë§Œ ë°°í¬ìš© ì¸ì¦ì„œ í•„ìš”)
    # Multis ì•±ì˜ ê²½ìš° match ê±´ë„ˆë›°ê¸° (OpenSSL ì•”í˜¸í™” ë¬¸ì œë¡œ ì¸í•´)
    unless bundle_id == "com.annapo.taskfolio"
      match(type: "appstore", app_identifier: bundle_id, readonly: true, username: "mooyoung2309@gmail.com")
    else
      UI.message("Multis ì•±ì€ ìë™ ì½”ë“œ ì‚¬ì´ë‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤ (match ê±´ë„ˆë›°ê¸°)")
    end

    # ë§¤í¬ë¡œ í™œì„±í™”ë¥¼ ìœ„í•œ ì¶”ê°€ ì„¤ì • (build laneê³¼ ë™ì¼)
    ENV["ENABLE_USER_SCRIPT_SANDBOXING"] = "NO"
    
    # ë¹Œë“œ ì¶œë ¥ ë””ë ‰í† ë¦¬ ìƒì„±
    sh("mkdir -p ./build")

    # ë¹Œë“œ & ì—…ë¡œë“œ (build laneì—ì„œ ì„±ê³µí•œ ì„¤ì • ì ìš©)
    if bundle_id == "com.annapo.taskfolio"
      # Multis ì•±ì˜ ê²½ìš° ìë™ ì½”ë“œ ì‚¬ì´ë‹ ì‚¬ìš©
      gym(
        workspace: "#{WORKSPACE_NAME}.xcworkspace",
        scheme: app_name,
        configuration: "Release",
        export_method: "app-store",
        clean: false,
        destination: "generic/platform=iOS",
        skip_package_dependencies_resolution: true,
        disable_package_automatic_updates: true,
        output_directory: "./build",
        output_name: app_name,
        xcargs: "-allowProvisioningUpdates -skipMacroValidation",
        export_options: {
          method: "app-store",
          compileBitcode: false,
          uploadBitcode: false,
          uploadSymbols: true,
          manageAppVersionAndBuildNumber: false
        }
      )
    else
      # ë‹¤ë¥¸ ì•±ë“¤ì€ ê¸°ì¡´ match ë°©ì‹ ì‚¬ìš©
      gym(
        workspace: "#{WORKSPACE_NAME}.xcworkspace",
        scheme: app_name,
        configuration: "Release",
        export_method: "app-store",
        clean: false,
        destination: "generic/platform=iOS",
        skip_package_dependencies_resolution: true,
        disable_package_automatic_updates: true,
        output_directory: "./build",
        output_name: app_name,
        xcargs: "-allowProvisioningUpdates -skipMacroValidation",
        export_options: {
          method: "app-store",
          provisioningProfiles: {
            bundle_id => "match AppStore #{bundle_id}"
          },
          compileBitcode: false,
          uploadBitcode: false,
          uploadSymbols: true,
          manageAppVersionAndBuildNumber: false
        }
      )
    end
    
    upload_to_testflight(
      ipa: "./build/#{app_name}.ipa",
      skip_waiting_for_build_processing: true
    )
    UI.success("#{app_name} uploaded! ğŸ‰")
  end
  
  desc "Reset certificates"
  lane :reset do
    ["development", "appstore"].each do |type|
      match_nuke(type: type, app_identifier: APPS.values)
      match(type: type, app_identifier: APPS.values, readonly: false, username: "mooyoung2309@gmail.com")
    end
    UI.success("Certificates reset! ğŸ”")
  end
end